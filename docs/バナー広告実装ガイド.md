# バナー広告実装ガイド

## 概要
このドキュメントでは、Tomica VaultアプリにGoogle AdMobを使用したバナー広告を実装する方法を説明します。`react-native-google-mobile-ads`ライブラリを使用して、子供向けアプリに適した広告を配信します。

## 前提条件
- React Native with Expo 53.0.17
- Google AdMobアカウント
- AdMobでアプリとバナー広告ユニットが作成済み

## 1. ライブラリのインストール

### Expoプロジェクトの場合
```bash
cd tomica-vault-app
npx expo install react-native-google-mobile-ads
```

### 必要な権限ライブラリ（iOS用）
```bash
npx expo install react-native-permissions
# または
npx expo install expo-tracking-transparency
```

## 2. 設定ファイルの更新

### app.json の設定
```json
{
  "expo": {
    "plugins": [
      [
        "react-native-google-mobile-ads",
        {
          "androidAppId": "ca-app-pub-xxxxxxxx~xxxxxxxx",
          "iosAppId": "ca-app-pub-xxxxxxxx~xxxxxxxx",
          "userTrackingUsageDescription": "この識別子は、パーソナライズされた広告を配信するために使用されます。",
          "skAdNetworkItems": [
            "cstr6suwn9.skadnetwork",
            "4fzdc2evr5.skadnetwork",
            "2fnua5tdw4.skadnetwork",
            "ydx93a7ass.skadnetwork",
            "p78axxw29g.skadnetwork",
            "v72qych5uu.skadnetwork"
          ]
        }
      ],
      [
        "expo-build-properties",
        {
          "ios": {
            "useFrameworks": "static"
          }
        }
      ]
    ]
  }
}
```

## 3. AdMob SDK の初期化

### メインアプリファイル（_layout.tsx）での初期化

```typescript
import { useEffect } from 'react';
import mobileAds, { MaxAdContentRating } from 'react-native-google-mobile-ads';

export default function RootLayout() {
  useEffect(() => {
    const initializeAds = async () => {
      try {
        // リクエスト設定
        await mobileAds().setRequestConfiguration({
          // 子供向けコンテンツとして扱う
          tagForChildDirectedTreatment: true,
          // 同意年齢未満として扱う
          tagForUnderAgeOfConsent: true,
          // 最大広告コンテンツ評価
          maxAdContentRating: MaxAdContentRating.G,
          // テストデバイス（開発時のみ）
          testDeviceIdentifiers: __DEV__ ? ['EMULATOR'] : [],
        });

        // SDK初期化
        const adapterStatuses = await mobileAds().initialize();
        console.log('AdMob SDK初期化完了:', adapterStatuses);
      } catch (error) {
        console.error('AdMob SDK初期化エラー:', error);
      }
    };

    initializeAds();
  }, []);

  return (
    // 既存のレイアウト
  );
}
```

## 4. バナー広告コンポーネントの実装

### components/BannerAdComponent.tsx
```typescript
import React, { useRef } from 'react';
import { View, StyleSheet, Platform } from 'react-native';
import { BannerAd, BannerAdSize, TestIds, useForeground } from 'react-native-google-mobile-ads';

interface BannerAdComponentProps {
  unitId?: string;
  size?: BannerAdSize;
  style?: any;
}

export const BannerAdComponent: React.FC<BannerAdComponentProps> = ({
  unitId,
  size = BannerAdSize.ADAPTIVE_BANNER,
  style
}) => {
  const bannerRef = useRef<BannerAd>(null);

  // 開発用とプロダクション用のAd Unit IDを切り替え
  const adUnitId = unitId || (__DEV__ ? TestIds.ADAPTIVE_BANNER : 'ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy');

  // iOS用：アプリがフォアグラウンドに戻った時に広告を再読み込み
  useForeground(() => {
    Platform.OS === 'ios' && bannerRef.current?.load();
  });

  return (
    <View style={[styles.container, style]}>
      <BannerAd
        ref={bannerRef}
        unitId={adUnitId}
        size={size}
        requestOptions={{
          requestNonPersonalizedAdsOnly: false,
          networkExtras: {
            // 折りたたみ可能バナー（オプション）
            collapsible: 'bottom',
          },
        }}
        onAdLoaded={() => {
          console.log('バナー広告読み込み完了');
        }}
        onAdFailedToLoad={(error) => {
          console.warn('バナー広告読み込み失敗:', error);
        }}
      />
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    alignItems: 'center',
    marginVertical: 10,
  },
});
```

## 5. 各画面への広告配置

### ホーム画面（app/(tabs)/index.tsx）
```typescript
import { BannerAdComponent } from '../../components/BannerAdComponent';

export default function HomeScreen() {
  // 既存のコード...

  return (
    <>
      <Stack.Screen options={{ headerShown: false }} />
      <View style={[styles.container, { backgroundColor }]}>
        <CustomHeader />

        <ScrollView
          style={[styles.content, { backgroundColor }]}
          contentContainerStyle={[styles.contentContainer, { backgroundColor }]}
          showsVerticalScrollIndicator={false}
          bounces={true}
          overScrollMode="never"
          refreshControl={
            <RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={tintColor} />
          }
        >
          {stats && (
            <>
              {/* 統計カード */}
              <View style={styles.statsContainer}>
                {/* 既存の統計カード */}
              </View>

              {/* バナー広告 */}
              <BannerAdComponent 
                unitId="ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy"
                style={{ marginVertical: 16 }}
              />

              {/* 最近のアクティビティ */}
              <RecentActivity activities={stats.recentActivity} animationKey={animationKey} />
            </>
          )}
        </ScrollView>

        <NFCShortcut />
      </View>
    </>
  );
}
```

### 一覧画面（app/(tabs)/list.tsx）
```typescript
import { BannerAdComponent } from '../../components/BannerAdComponent';

export default function ListScreen() {
  // 既存のコード...

  return (
    <View style={[styles.container, { backgroundColor }]}>
      {/* 既存のヘッダーとフィルター */}
      
      <FlatList
        data={filteredAndSortedTomicaList}
        renderItem={({ item }) => (
          <TomicaItem key={item.id} tomica={item} />
        )}
        keyExtractor={(item) => item.id.toString()}
        style={[styles.list, { backgroundColor }]}
        ListEmptyComponent={
          <View style={styles.emptyContainer}>
            <Text style={[styles.emptyText, { color: textColor }]}>
              トミカが見つかりませんでした
            </Text>
          </View>
        }
        ListFooterComponent={() => (
          <View style={styles.footer}>
            {/* バナー広告 */}
            <BannerAdComponent 
              unitId="ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy"
            />
          </View>
        )}
      />

      <NFCShortcut />
    </View>
  );
}

const styles = StyleSheet.create({
  // 既存のスタイル...
  footer: {
    paddingVertical: 20,
    paddingBottom: 100, // NFCショートカット分のスペース
  },
});
```

## 6. 環境変数での管理（推奨）

### .env ファイル
```
EXPO_PUBLIC_ADMOB_ANDROID_APP_ID=ca-app-pub-xxxxxxxx~xxxxxxxx
EXPO_PUBLIC_ADMOB_IOS_APP_ID=ca-app-pub-xxxxxxxx~xxxxxxxx
EXPO_PUBLIC_ADMOB_BANNER_UNIT_ID=ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy
```

### 環境変数を使用したコンポーネント
```typescript
const adUnitId = __DEV__ 
  ? TestIds.ADAPTIVE_BANNER 
  : process.env.EXPO_PUBLIC_ADMOB_BANNER_UNIT_ID;
```

## 7. App Tracking Transparency（iOS）

### 権限リクエストの実装
```typescript
import { getTrackingPermissionsAsync, requestTrackingPermissionsAsync, PermissionStatus } from 'expo-tracking-transparency';

const requestTrackingPermission = async () => {
  if (Platform.OS === 'ios') {
    const { status } = await getTrackingPermissionsAsync();
    if (status === PermissionStatus.UNDETERMINED) {
      await requestTrackingPermissionsAsync();
    }
  }
};

// SDK初期化前に実行
useEffect(() => {
  const initializeWithTracking = async () => {
    await requestTrackingPermission();
    // その後AdMob SDK初期化
  };
  
  initializeWithTracking();
}, []);
```

## 8. テストとデバッグ

### テスト用Ad Unit ID
```typescript
import { TestIds } from 'react-native-google-mobile-ads';

// 開発時は必ずテストIDを使用
const testAdUnitIds = {
  banner: TestIds.ADAPTIVE_BANNER,
  interstitial: TestIds.INTERSTITIAL,
  rewarded: TestIds.REWARDED,
};
```

### デバッグメニューの使用
```typescript
import mobileAds from 'react-native-google-mobile-ads';

// 開発時にデバッグメニューを開く
const openDebugMenu = async () => {
  if (__DEV__) {
    try {
      await mobileAds().openDebugMenu('ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy');
    } catch (error) {
      console.error('デバッグメニューエラー:', error);
    }
  }
};
```

## 9. パフォーマンス最適化

### 広告のプリロード
```typescript
const preloadAds = useCallback(() => {
  // バナー広告のプリロード処理
}, []);

useFocusEffect(preloadAds);
```

### メモリ管理
```typescript
useEffect(() => {
  return () => {
    // コンポーネントアンマウント時のクリーンアップ
  };
}, []);
```

## 10. トラブルシューティング

### よくある問題と解決方法

#### 1. 広告が表示されない
- テスト用Ad Unit IDを使用しているか確認
- AdMobアカウントでアプリが承認されているか確認
- app-ads.txtファイルに必要な行が追加されているか確認

#### 2. iOS で広告が空白になる
- `useForeground` フックを使用してアプリフォアグラウンド時に再読み込み
- Static Frameworksが有効になっているか確認

#### 3. Android でクラッシュする
- ProGuard設定でAdMobクラスが難読化されていないか確認

### ログ出力の設定
```typescript
// 開発時の詳細ログ
if (__DEV__) {
  console.log('AdMob広告関連のログを有効化');
}
```

## 11. 広告ポリシーの遵守

### 子供向けアプリでの注意事項
- 子供向けコンテンツとして適切に設定
- 個人情報の収集を制限
- 適切な広告コンテンツのフィルタリング

### 設定例
```typescript
await mobileAds().setRequestConfiguration({
  tagForChildDirectedTreatment: true,
  tagForUnderAgeOfConsent: true,
  maxAdContentRating: MaxAdContentRating.G,
});
```

## 12. 本番環境への移行

### チェックリスト
- [ ] テスト用Ad Unit IDを本番用に変更
- [ ] AdMobアカウントでアプリが承認済み
- [ ] app-ads.txtファイルの設定完了
- [ ] プライバシーポリシーの更新
- [ ] App Tracking Transparencyの実装（iOS）

### 本番用設定
```typescript
const adUnitId = __DEV__ 
  ? TestIds.ADAPTIVE_BANNER 
  : 'ca-app-pub-xxxxxxxxxxxxx/yyyyyyyyyyyyyy'; // 本番用ID
```

## 参考リンク
- [react-native-google-mobile-ads公式ドキュメント](https://github.com/invertase/react-native-google-mobile-ads)
- [Google AdMob ポリシー](https://support.google.com/admob/answer/6128543)
- [Expo Google Mobile Ads プラグイン](https://docs.expo.dev/guides/using-expo-plugins/)
- [子供向けアプリの広告ポリシー](https://support.google.com/googleplay/android-developer/answer/9283445)

## 更新履歴
- 2025-01-30: 初版作成