# Supabase認証機能テストガイド

## 概要
トミカヴォルトアプリに実装したSupabase認証機能のテスト手順です。

## 前提条件

### 1. データベーススキーマ更新
以下が完了していることを確認してください：
- [ ] `owned_tomica`テーブルに`user_id`カラムが追加済み
- [ ] Row Level Security (RLS) ポリシーが設定済み
- [ ] 型定義が再生成済み（`npm run generate-types`実行済み）

### 2. 環境変数設定
以下の環境変数が正しく設定されていることを確認：
```env
EXPO_PUBLIC_SUPABASE_URL=your_supabase_url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## テスト手順

### Phase 1: 基本認証機能テスト

#### 1.1 アプリ起動テスト
1. アプリを起動
2. **期待値**: 未認証のためログイン画面が表示される
3. **確認項目**:
   - ローディング画面が表示される
   - その後ログイン画面に自動遷移する
   - メイン画面に直接アクセスできない

#### 1.2 新規ユーザー登録テスト
1. ログイン画面から「新規登録」をタップ
2. サインアップ画面で以下を入力：
   - メールアドレス: `test@example.com`
   - パスワード: `password123`
   - パスワード確認: `password123`
3. 「新規登録」ボタンをタップ
4. **期待値**: 
   - 登録完了メッセージが表示される
   - 確認メール送信の通知が表示される

#### 1.3 メール確認テスト
1. 登録したメールアドレスのメールボックスを確認
2. Supabaseからの確認メールを開く
3. 確認リンクをクリック
4. **期待値**: 
   - アカウントが有効化される
   - アプリのメイン画面に遷移する

#### 1.4 ログインテスト
1. アプリを再起動（または手動ログアウト後）
2. ログイン画面で登録済みの認証情報を入力
3. 「ログイン」ボタンをタップ
4. **期待値**: 
   - ログインに成功する
   - メイン画面（ダッシュボード）に遷移する

#### 1.5 ログアウトテスト
1. 設定画面に移動
2. ユーザー情報が正しく表示されることを確認
3. 「ログアウト」ボタンをタップ
4. 確認ダイアログで「ログアウト」を選択
5. **期待値**: 
   - ログイン画面に遷移する
   - メイン画面にアクセスできない

### Phase 2: データアクセス制御テスト

#### 2.1 ユーザー別データ分離テスト
1. **ユーザーA**でログイン
2. トミカを数個追加（例：「レクサス」「トヨタ86」）
3. ログアウト
4. **ユーザーB**で新規登録・ログイン
5. トミカ一覧を確認
6. **期待値**: 
   - ユーザーBには空のリストが表示される
   - ユーザーAのデータは見えない

#### 2.2 トミカ追加・編集テスト
1. 各ユーザーでトミカを追加
2. 各ユーザーで自分のトミカのみ編集可能であることを確認
3. **期待値**: 
   - 自分が追加したトミカのみ表示される
   - 他のユーザーのデータは一切表示されない

#### 2.3 NFC機能テスト
1. 認証済みユーザーでNFC読み取り機能を使用
2. **期待値**: 
   - NFCタグの読み取りが正常に動作する
   - 読み取ったデータが正しいユーザーに関連付けられる

### Phase 3: エラーハンドリングテスト

#### 3.1 無効な認証情報テスト
1. 存在しないメールアドレスでログイン試行
2. 間違ったパスワードでログイン試行
3. **期待値**: 
   - 適切なエラーメッセージが表示される
   - 日本語でエラー内容が説明される

#### 3.2 バリデーションテスト
1. サインアップ画面で以下をテスト：
   - 空のフィールド
   - 無効なメールアドレス形式
   - 短すぎるパスワード（6文字未満）
   - パスワード不一致
2. **期待値**: 
   - 各ケースで適切なバリデーションエラーが表示される

#### 3.3 ネットワークエラーテスト
1. 機内モードにしてログイン試行
2. **期待値**: 
   - ネットワークエラーが適切に処理される
   - ユーザーにわかりやすいエラーメッセージが表示される

### Phase 4: パスワードリセットテスト

#### 4.1 パスワードリセット機能テスト
1. ログイン画面で「パスワードを忘れた方」をタップ
2. 登録済みのメールアドレスを入力
3. 「リセットメール送信」をタップ
4. **期待値**: 
   - 送信完了画面が表示される
   - パスワードリセットメールが届く

#### 4.2 パスワードリセット完了テスト
1. 受信したリセットメールのリンクをクリック
2. 新しいパスワードを設定
3. 新しいパスワードでログインテスト
4. **期待値**: 
   - パスワードが正常に更新される
   - 新しいパスワードでログインできる

## トラブルシューティング

### よくある問題と解決方法

#### 1. RLSエラー (`new row violates row-level security policy`)
**原因**: RLSポリシーが正しく設定されていない、またはuser_idが正しく設定されていない
**解決方法**:
```sql
-- RLSポリシーの確認
SELECT * FROM pg_policies WHERE tablename = 'owned_tomica';

-- auth.uid()の動作確認
SELECT auth.uid();
```

#### 2. 型定義エラー
**原因**: データベーススキーマ変更後に型定義が更新されていない
**解決方法**:
```bash
cd tomica-vault-app
npm run generate-types
```

#### 3. 認証状態が正しく反映されない
**原因**: AuthProviderの状態管理に問題がある
**解決方法**:
- アプリを完全に再起動
- ブラウザの場合はlocalStorageをクリア
- 開発者ツールでSupabaseセッションを確認

#### 4. メール確認が届かない
**原因**: Supabaseのメール設定またはスパムフィルタ
**解決方法**:
- 迷惑メールフォルダを確認
- Supabase Authentication > Email Templatesを確認
- 本番環境では独自SMTP設定を推奨

## セキュリティチェックリスト

### 開発環境
- [ ] `service_role`キーはサーバーサイドでのみ使用
- [ ] クライアントサイドでは`anon`キーのみ使用
- [ ] RLSポリシーが正しく設定されている
- [ ] ユーザーデータの分離が適切に動作している

### 本番環境
- [ ] HTTPS通信が設定されている
- [ ] 独自ドメインでのメール送信設定完了
- [ ] パスワードポリシーが適切に設定されている
- [ ] レート制限が設定されている

## パフォーマンステスト

### 1. 大量データテスト
1. 各ユーザーで100個以上のトミカデータを作成
2. 一覧表示・検索機能の動作確認
3. **期待値**: レスポンス時間が2秒以内

### 2. 同時アクセステスト
1. 複数ユーザーで同時にアプリを使用
2. データの整合性を確認
3. **期待値**: データの競合やエラーが発生しない

## テスト完了チェックリスト

- [ ] 新規ユーザー登録が正常に動作する
- [ ] メール確認プロセスが正常に動作する
- [ ] ログイン・ログアウトが正常に動作する
- [ ] ユーザー別データ分離が正常に動作する
- [ ] パスワードリセットが正常に動作する
- [ ] エラーハンドリングが適切に動作する
- [ ] NFC機能が認証状態で正常に動作する
- [ ] 設定画面でユーザー情報が正しく表示される
- [ ] セキュリティポリシーが適切に設定されている

---

このテストガイドに従って、認証機能が正常に動作することを確認してください。問題が発生した場合は、トラブルシューティングセクションを参照してください。